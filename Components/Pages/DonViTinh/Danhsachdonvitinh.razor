@page "/DonViTinh/Danhsachdonvitinh"
@using Microsoft.AspNetCore.Identity
@using cuahangbanle.Components.Services
@using cuahangbanle.DBData.Models
@using cuahangbanle.Data
@using cuahangbanle.Data.Models

@inject AuthenticationStateProvider auth
@inject IDonvitinhService donvitinhService
@inject UserManager<ApplicationUser> _userManager
@inject NavigationManager _navi
@inject IUserProfileService userProfileService

<PageTitle>Danh sách đơn vị tính</PageTitle>

<MudPaper>
    <MudTable Breakpoint="Breakpoint.None" Items="@donvitinhs" Filter="@filterTable" Virtualize>
        <ToolBarContent>
            <MudText>Danh sách đơn vị tính</MudText>
            <MudSpacer />
            <MudTextField T="string" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Placeholder="Tìm kiếm" @bind-Value="searchText" />
        </ToolBarContent>
        <HeaderContent>
            <MudTh>STT</MudTh>
            <MudTh>Mã đơn vị tính</MudTh>
            <MudTh>Đơn vị lẻ</MudTh>
            <MudTh>Đơn vị lớn</MudTh>
            <MudTh>Người tạo</MudTh>
            <MudTh>Ngày tạo</MudTh>
            <MudTh>Người sửa</MudTh>
            <MudTh>Ngày sửa</MudTh>
            <MudTh>Quản lý</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@(donvitinhs.IndexOf(context) + 1)</MudTd>
            <MudTd>@context.Madonvitinh</MudTd>
            <MudTd>@context.Donvile</MudTd>
            <MudTd>@context.Donvilon</MudTd>
            <MudTd>@(userProfiles.FirstOrDefault(p => p.UserId == context.Nguoitao.ToString())?.Hoten ?? "")</MudTd>
            <MudTd>@context.Ngaytao.ToString("dd/MM/yyyy")</MudTd>
            <MudTd>@(userProfiles.FirstOrDefault(p => p.UserId == context.Nguoisua?.ToString())?.Hoten ?? "")</MudTd>
            <MudTd>@(context.Ngaysua?.ToString("dd/MM/yyyy") ?? "")</MudTd>
            <MudTd>
                <MudMenu AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopRight">
                    <ActivatorContent>
                        <MudIconButton Icon="@Icons.Material.Filled.MoreVert" />
                    </ActivatorContent>
                    <ChildContent>
                        <MudNavMenu>
                            <MudNavLink>
                                <MudButton FullWidth Disabled="@isDisable" OnClick="@(() => Delete(context))">Xoá</MudButton>
                            </MudNavLink>
                            <MudNavLink>
                                <MudButton FullWidth Disabled="@isDisable" OnClick="@(() => Update(context.Madonvitinh))">Sửa</MudButton>
                            </MudNavLink>
                        </MudNavMenu>
                    </ChildContent>
                </MudMenu>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudPaper>

<MudTooltip Duration="1000" Delay="100" ShowOnHover Arrow Placement="Placement.Left" Text="Thêm ngành ngành">
    <MudIconButton OnClick="@Create" Disabled="@isDisable" Class="rounded-circle" Color="Color.Tertiary" Variant="Variant.Filled" Icon="@Icons.Material.Filled.Add" Size="Size.Large" />
</MudTooltip>

@code {
    bool isDisable = true;
    string searchText = "";
    List<Donvitinh> donvitinhs = new();
    List<UserProfile> userProfiles = new();

    protected override async Task OnInitializedAsync()
    {
        userProfiles = await userProfileService.GetAllProfile();
        donvitinhs = await donvitinhService.GetAllDonvitinh();
        var authState = await auth.GetAuthenticationStateAsync();
        var principal = authState.User;
        var userId = principal.FindFirst(p => p.Type.Contains("nameidentifier"))?.Value ?? "";
        var currentUser = await _userManager.FindByIdAsync(userId) ?? new();
        var roles = await _userManager.GetRolesAsync(currentUser);
        if (roles.Contains("Admin") || roles.Contains("Manager"))
        {
            isDisable = false;
        }
    }

    public async Task Delete(Donvitinh donvi)
    {
        await donvitinhService.RemoveDonvitinh(donvi);
        donvitinhs = await donvitinhService.GetAllDonvitinh();
    }

    public void Update(string id)
    {
        _navi.NavigateTo($"/DonViTinh/Danhsachdonvitinh/{id}");
    }

    public void Create()
    {
        _navi.NavigateTo($"/DonViTinh/Danhsachdonvitinh/{Guid.NewGuid().ToString()}");
    }

    private bool filterTable(Donvitinh donvi)
    {
        if (string.IsNullOrEmpty(searchText))
            return true;
        foreach (var property in donvi.GetType().GetProperties())
        {
            if (property.GetValue(donvi)?.ToString()?.Contains(searchText) ?? false)
            {
                return true;
            }
        }
        return false;
    }
}

<style>
    .mud-tooltip-root.mud-tooltip-inline {
        position: absolute;
        right: 5vw;
        top: 80vh;
        transform: scale(1.2);
    }
</style>
