@page "/NhomHang/Danhsachnhomhang/{id}"

@using cuahangbanle.Components.Services
@using cuahangbanle.DBData.Models
@using cuahangbanle.Data.Models

@inject NavigationManager Navigation
@inject INhomhangService nhomHangService
@inject AuthenticationStateProvider auth
@inject ISnackbar Snackbar

<PageTitle>Chi tiết nhóm hàng</PageTitle>

<MudGrid Justify="Justify.Center" Style="height: 60vh; align-content: center;">
    <MudItem xs="12" sm="10" md="6">
        <MudPaper Class="p-4">
            <MudGrid Spacing="1">
                <MudItem xs="12">
                    <MudTextField ReadOnly="true" Label="Mã nhóm hàng" HelperText="Mã nhóm hàng được tạo tự động và không thể sửa" @bind-Value="@nhomhang.Manhomhang" />
                </MudItem>
                <MudItem xs="12" Class="mb-3">
                    <MudTextField T="string" Label="Tên nhóm hàng" HelperText="Điền tên nhóm hàng" @bind-Value="@nhomhang.Tennhomhang" />
                </MudItem>
                <MudItem xs="6">
                    <MudButton FullWidth Variant="Variant.Filled" Color="Color.Error" OnClick="@Cancel">Huỷ và quay lại</MudButton>
                </MudItem>
                <MudItem xs="6">
                    <MudButton FullWidth Variant="Variant.Filled" Color="Color.Primary" OnClick="@Save">Lưu</MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    [Parameter]
    public string? id { get; set; }
    public Nhomhang nhomhang = new();
    bool isNew = false;

    protected override async Task OnInitializedAsync()
    {
        nhomhang = await nhomHangService.GetNhomhangById(id ?? "");
        if (nhomhang.Manhomhang == "")
        {
            isNew = true;
            nhomhang.Manhomhang = id ?? Guid.NewGuid().ToString();
        }
    }

    public void Cancel()
    {
        Navigation.NavigateTo("/NhomHang/Danhsachnhomhang");
    }

    public bool checkNameNull()
    {
        if (string.IsNullOrEmpty(nhomhang.Tennhomhang))
        {
            Snackbar.Add("Tên nhóm không được để trống", Severity.Error);
            return true;
        }
        return false;
    }

    public async Task Save()
    {
        var authState = await auth.GetAuthenticationStateAsync();
        var principal = authState.User;
        var userId = principal.FindFirst(p => p.Type.Contains("nameidentifier"))?.Value ?? "";
        if (checkNameNull())
        {
            return;
        }
        if (isNew)
        {
            nhomhang.Nguoitao = userId;
            nhomhang.Ngaytao = DateTime.Now;
            await nhomHangService.CreateNhomhang(nhomhang);
        }
        else
        {
            nhomhang.Nguoisua = userId;
            nhomhang.Ngaysua = DateTime.Now;
            await nhomHangService.UpdateNhomhang(nhomhang);
        }
        Navigation.NavigateTo("/NhomHang/Danhsachnhomhang");
    }
}

