@page "/NhaCungCap/Danhsachnhacungcap"
@using Microsoft.AspNetCore.Identity
@using cuahangbanle.Components.Services
@using cuahangbanle.DBData.Models
@using cuahangbanle.Data
@using cuahangbanle.Data.Models

@inject AuthenticationStateProvider auth
@inject INhacungcapService nhacungcapService
@inject UserManager<ApplicationUser> _userManager
@inject NavigationManager _navi
@inject IUserProfileService userProfileService

<PageTitle>Danh sách nhà cung cấp</PageTitle>

<MudPaper>
    <MudTable Breakpoint="Breakpoint.None" Items="@nhacungcaps" Filter="@filterTable" Virtualize>
        <ToolBarContent>
            <MudText>Danh sách nhà cung cấp</MudText>
            <MudSpacer />
            <MudTextField T="string" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" Placeholder="Tìm kiếm" @bind-Value="searchText" />
        </ToolBarContent>
        <HeaderContent>
            <MudTh>STT</MudTh>
            <MudTh>Mã nhà cung cấp</MudTh>
            <MudTh>Tên nhà cung cấp</MudTh>
            <MudTh>Địa chỉ</MudTh>
            <MudTh>SĐT</MudTh>
            <MudTh>Email</MudTh>
            <MudTh>Người tạo</MudTh>
            <MudTh>Ngày tạo</MudTh>
            <MudTh>Người sửa</MudTh>
            <MudTh>Ngày sửa</MudTh>
            <MudTh>Quản lý</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@(nhacungcaps.IndexOf(context) + 1)</MudTd>
            <MudTd>@context.MaNCC</MudTd>
            <MudTd>@context.TenNCC</MudTd>
            <MudTd>@(context.Diachi ?? "")</MudTd>
            <MudTd>@(context.Dienthoai ?? "")</MudTd>
            <MudTd>@(context.Email ?? "")</MudTd>
            <MudTd>@(userProfiles.FirstOrDefault(p => p.UserId == context.Nguoitao.ToString())?.Hoten ?? "")</MudTd>
            <MudTd>@context.Ngaytao.ToString("dd/MM/yyyy")</MudTd>
            <MudTd>@(userProfiles.FirstOrDefault(p => p.UserId == context.Nguoisua?.ToString())?.Hoten ?? "")</MudTd>
            <MudTd>@(context.Ngaysua?.ToString("dd/MM/yyyy") ?? "")</MudTd>
            <MudTd>
                <MudMenu AnchorOrigin="Origin.BottomCenter" TransformOrigin="Origin.TopRight">
                    <ActivatorContent>
                        <MudIconButton Icon="@Icons.Material.Filled.MoreVert" />
                    </ActivatorContent>
                    <ChildContent>
                        <MudNavMenu>
                            <MudNavLink>
                                <MudButton FullWidth Disabled="@isDisable" OnClick="@(() => Delete(context))">Xoá</MudButton>
                            </MudNavLink>
                            <MudNavLink>
                                <MudButton FullWidth Disabled="@isDisable" OnClick="@(() => Update(context.MaNCC))">Sửa</MudButton>
                            </MudNavLink>
                        </MudNavMenu>
                    </ChildContent>
                </MudMenu>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudPaper>

<MudTooltip Duration="1000" Delay="100" ShowOnHover Arrow Placement="Placement.Left" Text="Thêm ngành ngành">
    <MudIconButton OnClick="@Create" Disabled="@isDisable" Class="rounded-circle" Color="Color.Tertiary" Variant="Variant.Filled" Icon="@Icons.Material.Filled.Add" Size="Size.Large" />
</MudTooltip>

@code {
    bool isDisable = true;
    string searchText = "";
    List<Nhacungcap> nhacungcaps = new();
    List<UserProfile> userProfiles = new();

    protected override async Task OnInitializedAsync()
    {
        userProfiles = await userProfileService.GetAllProfile();
        nhacungcaps = await nhacungcapService.GetAllNhacungcap();
        var authState = await auth.GetAuthenticationStateAsync();
        var principal = authState.User;
        var userId = principal.FindFirst(p => p.Type.Contains("nameidentifier"))?.Value ?? "";
        var currentUser = await _userManager.FindByIdAsync(userId) ?? new();
        var roles = await _userManager.GetRolesAsync(currentUser);
        if (roles.Contains("Admin") || roles.Contains("Manager"))
        {
            isDisable = false;
        }
    }

    public async Task Delete(Nhacungcap nganh)
    {
        await nhacungcapService.RemoveNhacungcap(nganh);
        nhacungcaps = await nhacungcapService.GetAllNhacungcap();
    }

    public void Update(string id)
    {
        _navi.NavigateTo($"/NhaCungCap/Danhsachnhacungcap/{id}");
    }

    public void Create()
    {
        _navi.NavigateTo($"/NhaCungCap/Danhsachnhacungcap/{Guid.NewGuid().ToString()}");
    }

    private bool filterTable(Nhacungcap nganh)
    {
        if (string.IsNullOrEmpty(searchText))
            return true;
        foreach (var property in nganh.GetType().GetProperties())
        {
            if (property.GetValue(nganh)?.ToString()?.Contains(searchText) ?? false)
            {
                return true;
            }
        }
        return false;
    }
}

<style>
    .mud-tooltip-root.mud-tooltip-inline {
        position: absolute;
        right: 5vw;
        top: 80vh;
        transform: scale(1.2);
    }
</style>
